<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Kindora — Donate Food</title>
    <style>
        /* --- Theme tokens --- */
        :root{
          --soft-yellow:#f7e99a;
          --teal:#1f6a63;
          --muted:#5b6b63;
          --card:#fff5d6;
          --bg:#fffdf7;
          --max:720px;
          --rounded:14px;
          --shadow-soft:0 8px 40px rgba(0,0,0,0.06);
          --input-radius:10px;
          --accent-btn-radius:28px;
          --err:#d9534f;
          --font-sans:"Poppins", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        }

        /* Base / reset */
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;background:var(--bg);font-family:var(--font-sans);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
        a{color:inherit;text-decoration:none}
        .container{max-width:100%;margin:20px auto;padding:0 16px}

        /* Header */
        .site-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:#fff;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,0.04)}
        .header-left{display:flex;align-items:center;gap:12px}
        .hamburger{width:44px;height:38px;border-radius:10px;border:0;background:var(--teal);display:flex;flex-direction:column;justify-content:center;padding:6px;color:#fff;cursor:pointer}
        .hamburger .bar{height:3px;background:#fff;border-radius:3px;margin:2px 0}
        .brand{display:flex;align-items:center;gap:10px;white-space:nowrap}
        .logo-16x9{width:90px;height:50px;border-radius:8px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center}
        .logo-16x9 img{width:100%;height:100%;object-fit:cover;display:block}
        .app-title{font-weight:700;color:var(--teal);font-size:20px}

        /* profile dropdown */
        .profile-wrap{position:relative}
        .profile{width:42px;height:42px;border-radius:50%;background:var(--teal);color:#fff;display:grid;place-items:center;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
        .profile-menu{position:absolute;right:0;top:54px;background:#fff;border-radius:10px;box-shadow:0 8px 26px rgba(0,0,0,0.12);overflow:hidden;display:none;min-width:160px}
        .profile-menu a{display:block;padding:10px 12px;color:var(--muted);font-weight:700}
        .profile-menu a:hover{background:#f4f9f6;color:var(--teal)}

        /* Mobile menu */
        .mobile-menu{position:fixed;left:0;top:0;height:100vh;width:320px;max-width:86vw;background:#fff;transform:translateX(-120%);transition:transform .28s;box-shadow:6px 0 30px rgba(0,0,0,0.14);z-index:200;border-radius:0 12px 12px 0;overflow:auto;padding:16px}
        .mobile-menu.open{transform:translateX(0)}
        .mobile-header{display:flex;align-items:center;justify-content:space-between;padding-bottom:6px;border-bottom:1px solid #f4f4f4}
        .dash-btn{display:block;padding:12px;border-radius:28px;text-align:center;color:#fff;font-weight:700;margin-bottom:10px}
        .dash-btn.primary{background:var(--teal)}
        .dash-btn.secondary{background:#ffeaa8;color:var(--teal)}
        .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.18);opacity:0;pointer-events:none;transition:opacity .2s;z-index:190}
        .overlay.show{opacity:1;pointer-events:auto}

        /* Main form card */
        .card{
          background:#fff;
          padding:18px;
          margin-top:0;
          border-radius:0;   /* removes round card corners */
          box-shadow:none;   /* removes the floating card look */
          width:100%;
        }

        .banner{background:var(--soft-yellow);border-radius:12px;padding:22px 18px;text-align:center;margin-bottom:10px}
        .banner h1{margin:0;font-size:34px;color:var(--teal);font-weight:800}
        .banner p{margin:10px 0 0;color:var(--muted);font-weight:600}

        /* Form layout */
        .form-section{margin-top:10px}
        .section-label{font-weight:800;color:var(--teal);margin-bottom:8px;display:flex;align-items:center;gap:8px;font-size:16px}
        .section-label .req{color:var(--err);font-weight:900}

        /* Food types */
        .food-types{display:flex;gap:10px}
        .food-card{flex:1;background:#f9f7ef;border-radius:12px;padding:12px 8px;text-align:center;border:2px solid transparent;cursor:pointer;transition:transform .12s,border-color .12s,background .12s;display:flex;flex-direction:column;align-items:center;gap:8px;min-height:94px;justify-content:center}
        .food-card img{width:56px;height:56px;object-fit:contain;display:block;margin:0 auto}
        .food-card .label{font-weight:700;color:var(--muted);margin-top:4px}
        .food-card.selected{background:var(--teal);color:#fff;border-color:rgba(0,0,0,0.06)}
        .food-card.selected .label{color:#fff}

        /* Input grid */
        .row{display:flex;gap:10px;flex-wrap:wrap}
        .input,.select,.time{flex:1;padding:10px;border-radius:var(--input-radius);border:1px solid #e6e4d8;background:transparent;font-size:15px}
        .input::placeholder{color:#9aa39c}
        .small{flex:0 0 34%}
        .small-2{flex:0 0 30%}

        /* Add item */
        .add-item{display:inline-block;color:var(--teal);font-weight:700;margin-top:6px;cursor:pointer}

        /* Upload box */
        .upload-box{margin-top:10px;border-radius:12px;border:2px dashed rgba(31,106,99,0.12);padding:18px;text-align:center;background:#fffaf0;color:var(--muted);cursor:pointer;display:block}
        .upload-preview{max-width:100%;border-radius:10px;margin-top:8px;display:none}

        /* Submit */
        .submit-wrap{text-align:center;margin-top:18px}
        .btn-submit{background:var(--teal);color:#fff;padding:14px 28px;border-radius:28px;border:0;font-weight:800;font-size:20px;box-shadow:0 8px 18px rgba(0,0,0,0.12);cursor:pointer}

        /* errors */
        .field-error{border-color:var(--err) !important;box-shadow:0 0 0 3px rgba(217,83,79,0.06) !important}
        .err-msg{color:var(--err);font-size:13px;margin-top:6px}

        /* food types error indicator */
        .food-types.err{outline:3px solid rgba(217,83,79,0.08);border-radius:12px;padding:6px}

        /* Thanks modal */
        .thanks-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.98);background:#fff;border-radius:14px;padding:20px;box-shadow:0 8px 40px rgba(0,0,0,0.18);z-index:300;min-width:280px;max-width:90vw;display:none;text-align:center}
        .thanks-modal.show{display:block}
        .thanks-modal h3{margin:0;color:var(--teal)}
        .thanks-modal p{color:var(--muted);margin:10px 0 0}

        /* items */
        .item-row { align-items: center; gap:10px; margin-bottom:10px; }
        .item-row .remove-item {
          background: transparent;
          border: 1px solid rgba(0,0,0,0.08);
          padding:6px 8px;
          border-radius:8px;
          cursor:pointer;
          color:var(--muted);
          font-weight:700;
        }
        .item-row .remove-item:hover { transform:translateY(-2px); }

        @media (max-width:520px){
          .container{padding:0 12px}
          .banner h1{font-size:28px}
          .food-card img{width:48px;height:48px}
          .small{flex:0 0 48%}
          .small-2{flex:0 0 48%}
        }

        a, a:hover, a:active, a:focus { text-decoration:none; outline:none }
    </style>
</head>
<body>

<!-- overlay for mobile menu -->
<div id="overlay" class="overlay" aria-hidden="true"></div>

<!-- mobile menu -->
<aside id="mobile-menu" class="mobile-menu" aria-hidden="true" aria-label="Dashboard menu">
    <div class="mobile-header">
        <strong>Menu</strong>
        <button id="mobile-close" aria-label="Close menu" style="font-size:20px;background:none;border:0;cursor:pointer">✕</button>
    </div>
    <div style="padding:12px">
        <a class="dash-btn primary" href="membersdashboard.html">Member Dashboard</a>
        <a class="dash-btn secondary" href="donardashboard.html">Donor Dashboard</a>
    </div>
</aside>

<div class="container">
    <!-- Header -->
    <header class="site-header" role="banner" aria-label="Top">
        <div class="header-left">
            <button id="hamburger" class="hamburger" aria-expanded="false" aria-controls="mobile-menu" aria-label="Open menu">
                <span class="bar"></span><span class="bar"></span><span class="bar"></span>
            </button>

            <div class="brand" role="img" aria-label="Kindora logo">
                <div class="logo-16x9"><img src="logo2.jpg" alt="Kindora logo"></div>
                <div class="app-title">Kindora</div>
            </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px">
            <!-- profile with dropdown -->
            <div class="profile-wrap">
                <div id="profileBtn" class="profile" tabindex="0" aria-haspopup="true" aria-expanded="false" aria-label="User menu">A</div>
                <div id="profileMenu" class="profile-menu" role="menu" aria-hidden="true">
                    <a href="#" id="viewProfile" role="menuitem">Profile</a>
                    <a href="#" id="logoutBtn" role="menuitem">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <!-- main card -->
    <main class="card" role="main" aria-labelledby="pageTitle">
        <!-- banner -->
        <div class="banner" role="region" aria-label="Donate Food header">
            <h1 id="pageTitle">Donate Food</h1>
            <p>Share your extra food with someone in need.</p>
        </div>

        <!-- FORM -->
        <form id="donationForm" novalidate>
            <!-- Food type -->
            <div class="form-section" id="foodTypeSection">
                <label class="section-label">Food type <span class="req" aria-hidden="true">*</span></label>
                <div class="food-types" id="foodTypes" role="group" aria-label="Food types (select one or more)">
                    <div class="food-card" data-value="tiffin" tabindex="0" role="button" aria-pressed="false">
                        <img src="tiffin.jpg" alt="Tiffin icon">
                        <div class="label">Tiffin</div>
                    </div>

                    <div class="food-card" data-value="lunch" tabindex="0" role="button" aria-pressed="false">
                        <img src="lunch.jpg" alt="Lunch icon">
                        <div class="label">Lunch</div>
                    </div>

                    <div class="food-card" data-value="snacks" tabindex="0" role="button" aria-pressed="false">
                        <img src="snacks.jpg" alt="Snacks icon">
                        <div class="label">Snacks</div>
                    </div>
                </div>
                <div id="foodTypesErr" class="err-msg" style="display:none">Please select at least one food type.</div>
            </div>

            <!-- Item details -->
            <label class="section-label">Item details</label>
            <!-- items container -->
            <div id="itemsList">
                <div class="row item-row" style="margin-bottom:6px">
                    <input type="text" name="itemName[]" class="input" placeholder="Item name (optional)" />
                    <input type="number" name="quantity[]" class="input small" min="1" placeholder="Quantity" />
                    <input type="number" name="serveCount[]" class="input small-2" min="1" placeholder="No. of people it can serve (optional)" />
                </div>
            </div>

            <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
                <button type="button" id="addItem" class="add-item">+ Add item</button>
                <div class="note" style="margin:0">You can add multiple items.</div>
            </div>


            <!-- Availability timings -->
            <div class="form-section">
                <label class="section-label">Availability Timings <span class="req" aria-hidden="true">*</span></label>
                <div class="row">
                    <input type="time" name="fromTime" class="time small" required aria-required="true">
                    <input type="time" name="toTime" class="time small" required aria-required="true">
                </div>
                <div id="timeErr" class="err-msg" style="display:none">Please select both times.</div>
            </div>

            <!-- Pickup location -->
            <div class="form-section">
                <label class="section-label">Pickup location <span class="req" aria-hidden="true">*</span></label>
                <div class="row" style="margin-bottom:8px">
                    <input type="text" name="pincode" class="input small" placeholder="Pincode" required aria-required="true">
                    <input type="text" name="street" class="input" placeholder="Street / Area" required aria-required="true">
                    <input type="text" name="district" class="input small" placeholder="District" required aria-required="true">
                </div>
                <div class="row">
                    <input type="text" name="state" class="input small" placeholder="State" required aria-required="true">
                    <input type="text" name="landmark" class="input" placeholder="Landmark (optional)">
                    <button type="button" id="useLocation" class="dash-btn" style="padding:10px 12px;border-radius:12px;background:var(--teal);color:#fff;border:0">Use location</button>
                </div>
                <div id="locationErr" class="err-msg" style="display:none">Please fill all pickup location fields.</div>
            </div>

            <!-- Latitude / Longitude (filled by Use location). Do NOT overwrite Street/Area. -->
            <div class="row" style="margin-top:8px; gap:8px; align-items:center;">
                <input type="text" name="lat" id="latField" class="input small" placeholder="Latitude" readonly aria-readonly="true" />
                <input type="text" name="lng" id="lngField" class="input small" placeholder="Longitude" readonly aria-readonly="true" />
                <div style="font-size:13px;color:var(--muted);">Click <strong>Use location</strong> to auto-fill</div>
            </div>
            <!-- KEEP locationErr element (used for validation messages) below the row if present -->


            <!-- Upload -->
            <div class="form-section">
                <label class="section-label">Upload food photo <span class="req" aria-hidden="true">*</span></label>
                <label for="photo" class="upload-box" id="uploadBox" tabindex="0">
                    <div id="uploadText">Tap to upload a photo of the food</div>
                    <input id="photo" name="photo" type="file" accept="image/*" style="display:none" required aria-required="true">
                    <img id="photoPreview" class="upload-preview" alt="Preview">
                </label>
                <div id="photoErr" class="err-msg" style="display:none">Please upload a food photo.</div>
            </div>

            <!-- submit -->
            <div class="submit-wrap">
                <button type="submit" id="submitBtn" class="btn-submit">Submit Donation</button>
            </div>
        </form>
    </main>
</div>

<!-- thanks modal -->
<div id="thanks" class="thanks-modal" role="dialog" aria-modal="true" aria-labelledby="thanksTitle" aria-hidden="true">
    <h3 id="thanksTitle">Thank you for donating!</h3>
    <p>We will inform nearby members. You will be notified once someone accepts the pickup.</p>
    <div style="margin-top:12px"><button id="thanksClose" style="background:var(--teal);color:#fff;padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer">Close</button></div>
</div>
<!-- PROFILE MODAL (do NOT make it visible by default) -->
<style>
    /* small modal CSS — can be placed in your main <style> too */
    .profile-modal__backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); align-items: center; justify-content: center; z-index: 9999; }
    .profile-modal__backdrop.show { display: flex; }
    .profile-modal { background:#fff; padding:20px; border-radius:12px; width:90%; max-width:420px; box-shadow:0 12px 40px rgba(0,0,0,0.25); }
    .profile-modal h2 { margin-top:0; color:var(--teal); }
    .profile-modal p { margin:8px 0; color:#264b47; }
</style>

<div id="profileModalBackdrop" class="profile-modal__backdrop" aria-hidden="true">
    <div class="profile-modal" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
        <h2 id="profileTitle">My Profile</h2>
        <p><strong>Name:</strong> <span id="pm_name">-</span></p>
        <p><strong>Email:</strong> <span id="pm_email">-</span></p>
        <p><strong>Phone:</strong> <span id="pm_phone">-</span></p>
        <p><strong>Role:</strong> <span id="pm_role">-</span></p>

        <div style="text-align:right;margin-top:12px">
            <button id="closeProfileModal" class="btn-ghost" style="padding:8px 14px;border:1px solid #ccc;border-radius:8px;cursor:pointer;">Close</button>
        </div>
    </div>
</div>

<script>
    // MAX upload size in bytes — change once if needed.
    // Example: 2.5 MB:
    const MAX_UPLOAD_BYTES = 2.5 * 1024 * 1024; // 2.5 MB
    // If you want a different limit (e.g. 2425 MB), set: const MAX_UPLOAD_BYTES = 2425 * 1024 * 1024;

    /* ---------- Utility: show / hide simple errors ---------- */
    function showMessage(id, text) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = text;
      el.style.display = 'block';
    }
    function hideMessage(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = 'none';
    }

    /* ---------- Page guard: require authentication (cookie-based) ---------- */
    (async function ensureAuth(){
      try {
        const res = await fetch('/api/auth/me', { credentials: 'include' });
        if (res.status === 401 || res.status === 403) {
          // not authenticated -> redirect to login
          window.location.href = '/authentication.html';
          return;
        }
        if (!res.ok) {
          console.error('Auth check failed', res.status);
          return;
        }
        const user = await res.json();
        const initial = (user.fullName || user.name || user.email || '').trim().charAt(0).toUpperCase() || 'A';
        const profileBtn = document.getElementById('profileBtn');
        if (profileBtn) profileBtn.textContent = initial;
        window.kindoraCurrentUser = user;
      } catch (err) {
        console.error('Auth check error', err);
      }
    })();

    /* ---------- Mobile menu ---------- */
    (function(){
      const hamburger = document.getElementById('hamburger');
      const mobileMenu = document.getElementById('mobile-menu');
      const mobileClose = document.getElementById('mobile-close');
      const overlay = document.getElementById('overlay');

      function openMenu(){
        mobileMenu && mobileMenu.classList.add('open');
        overlay && overlay.classList.add('show');
        if (mobileMenu) mobileMenu.setAttribute('aria-hidden','false');
        if (hamburger) hamburger.setAttribute('aria-expanded','true');
        document.body.style.overflow = 'hidden';
        const first = mobileMenu && mobileMenu.querySelector('.dash-btn');
        if (first) first.focus();
      }
      function closeMenu(){
        mobileMenu && mobileMenu.classList.remove('open');
        overlay && overlay.classList.remove('show');
        if (mobileMenu) mobileMenu.setAttribute('aria-hidden','true');
        if (hamburger) hamburger.setAttribute('aria-expanded','false');
        document.body.style.overflow = '';
        hamburger && hamburger.focus();
      }

      if (hamburger && mobileMenu && overlay){
        hamburger.addEventListener('click', () => { mobileMenu.classList.contains('open') ? closeMenu() : openMenu(); });
        mobileClose && mobileClose.addEventListener('click', closeMenu);
        overlay && overlay.addEventListener('click', closeMenu);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && mobileMenu.classList.contains('open')) closeMenu(); });
      }
    })();

    /* ---------- Profile menu + logout (POST /api/auth/logout cookie-based) ---------- */
    (function(){
      const profileBtn = document.getElementById('profileBtn');
      const profileMenu = document.getElementById('profileMenu');

      function openProfile(){ if(profileMenu){ profileMenu.style.display='block'; profileMenu.setAttribute('aria-hidden','false'); } if(profileBtn) profileBtn.setAttribute('aria-expanded','true'); }
      function closeProfile(){ if(profileMenu){ profileMenu.style.display='none'; profileMenu.setAttribute('aria-hidden','true'); } if(profileBtn) profileBtn.setAttribute('aria-expanded','false'); }

      if (profileBtn){
        profileBtn.addEventListener('click', () => { const open = profileBtn.getAttribute('aria-expanded') === 'true'; open ? closeProfile() : openProfile(); });
        profileBtn.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeProfile(); if (e.key === 'Enter') { const open = profileBtn.getAttribute('aria-expanded') === 'true'; open ? closeProfile() : openProfile(); } });

        document.addEventListener('click', (e) => {
          if (!profileBtn.contains(e.target) && !profileMenu.contains(e.target)) closeProfile();
        });
      }

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) logoutBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
          window.location.href = '/authentication.html';
        } catch (err) {
          console.error('Logout failed', err);
          window.location.href = '/authentication.html';
        }
      });
    })();
// PROFILE modal logic (use class toggles)
const viewProfile = document.getElementById("viewProfile");
const modalBackdrop = document.getElementById("profileModalBackdrop");
const closeProfileModal = document.getElementById("closeProfileModal");

async function openProfileModalWithData() {
  try {
    const res = await fetch('/api/auth/me', { credentials: 'include' });
    if (!res.ok) return; // do nothing if not logged in
    const user = await res.json();

    document.getElementById("pm_name").textContent = user.fullName || user.name || '-';
    document.getElementById("pm_email").textContent = user.email || user.username || '-';
    document.getElementById("pm_phone").textContent = user.phoneNumber || user.phone || user.mobile || '-';
    document.getElementById("pm_role").textContent = user.role || '-';

    modalBackdrop.classList.add('show');
    modalBackdrop.setAttribute('aria-hidden', 'false');
  } catch (err) {
    console.error('Failed to load profile', err);
  }
}

function closeProfileModalFn() {
  modalBackdrop.classList.remove('show');
  modalBackdrop.setAttribute('aria-hidden', 'true');
}

// wiring
if (viewProfile) {
  viewProfile.addEventListener('click', function (e) {
    e.preventDefault();
    openProfileModalWithData();
  });
}
if (closeProfileModal) closeProfileModal.addEventListener('click', closeProfileModalFn);

// close when clicking on backdrop itself
if (modalBackdrop) {
  modalBackdrop.addEventListener('click', function (ev) {
    if (ev.target === modalBackdrop) closeProfileModalFn();
  });
}

    /* ---------- Food cards multi-select + keyboard ---------- */
    (function(){
      const cards = Array.from(document.querySelectorAll('.food-card'));
      cards.forEach(card => {
        function toggle(){
          const is = card.classList.toggle('selected');
          card.setAttribute('aria-pressed', is ? 'true' : 'false');
          const ft = document.getElementById('foodTypes');
          const ferr = document.getElementById('foodTypesErr');
          if (ft && ferr) { ft.classList.remove('err'); ferr.style.display='none'; }
        }
        card.addEventListener('click', toggle);
        card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); } });
      });
    })();

    /* ---------- Upload preview ---------- */
    (function(){
      const photoInput = document.getElementById('photo');
      const uploadBox = document.getElementById('uploadBox');
      const preview = document.getElementById('photoPreview');
      const uploadText = document.getElementById('uploadText');

      uploadBox && uploadBox.addEventListener('click', () => { photoInput && photoInput.click(); });
      uploadBox && uploadBox.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); photoInput && photoInput.click(); } });

      if (photoInput){
        photoInput.addEventListener('change', function(){
          const file = this.files && this.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function(e){
            preview.src = e.target.result;
            preview.style.display = 'block';
            if (uploadText) uploadText.style.display = 'none';
            const perr = document.getElementById('photoErr'); perr && (perr.style.display='none');
            photoInput.classList.remove('field-error');
          };
          reader.readAsDataURL(file);
        });
      }
    })();

    /* use location (fills lat/lng only — does NOT overwrite street) */
    (function(){
      const btn = document.getElementById('useLocation');
      if (!btn) return;
      btn.addEventListener('click', function(){
        if (!navigator.geolocation){ alert('Geolocation not supported by your browser'); return; }
        btn.disabled = true; const orig = btn.textContent; btn.textContent = 'Detecting...';
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat = pos.coords.latitude.toFixed(6);
          const lon = pos.coords.longitude.toFixed(6);
          // fill visible lat/lng fields only
          const latField = document.getElementById('latField');
          const lngField = document.getElementById('lngField');
          if (latField) latField.value = lat;
          if (lngField) lngField.value = lon;
          // optional: change button label briefly to indicate success
          btn.textContent = 'Location detected';
          setTimeout(()=> { btn.textContent = orig; }, 1400);
          btn.disabled = false;
        }, (err) => {
          alert('Unable to detect location — please allow location or enter address manually.');
          btn.disabled = false; btn.textContent = orig;
        }, { timeout:15000 });
      });
    })();

    /* ---------- ADD / REMOVE ITEM ROWS ---------- */
    (function(){
      const addBtn = document.getElementById('addItem');
      const itemsList = document.getElementById('itemsList');

      if (!addBtn || !itemsList) return;

      const initialItemsHTML = itemsList.innerHTML;

      function createItemRow() {
        const wrapper = document.createElement('div');
        wrapper.className = 'row item-row';

        const itemInput = document.createElement('input');
        itemInput.type = 'text';
        itemInput.name = 'itemName[]';
        itemInput.className = 'input';
        itemInput.placeholder = 'Item name (optional)';
        itemInput.setAttribute('aria-label', 'Item name (optional)');

        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.name = 'quantity[]';
        qtyInput.className = 'input small';
        qtyInput.placeholder = 'Quantity';
        qtyInput.min = 1;
        qtyInput.setAttribute('aria-label', 'Quantity');

        const serveInput = document.createElement('input');
        serveInput.type = 'number';
        serveInput.name = 'serveCount[]';
        serveInput.className = 'input small-2';
        serveInput.placeholder = 'No. of people it can serve (optional)';
        serveInput.min = 1;
        serveInput.setAttribute('aria-label', 'No. of people it can serve (optional)');

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-item';
        removeBtn.textContent = 'Remove';
        removeBtn.setAttribute('aria-label', 'Remove this item');

        removeBtn.addEventListener('click', function(e){
          e.preventDefault();
          wrapper.remove();
        });
        removeBtn.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); wrapper.remove(); }
        });

        wrapper.appendChild(itemInput);
        wrapper.appendChild(qtyInput);
        wrapper.appendChild(serveInput);
        wrapper.appendChild(removeBtn);

        return wrapper;
      }

      addBtn.addEventListener('click', function(e){
        e.preventDefault();
        const newRow = createItemRow();
        itemsList.appendChild(newRow);
        const first = newRow.querySelector('input');
        if (first) first.focus();
      });

      window.__kindora_restoreItems = function(){
        if (!itemsList) return;
        itemsList.innerHTML = initialItemsHTML;
      };
    })();

    /* ---------- Form validation & submit (cookie auth) ---------- */
    (function(){
      const form = document.getElementById('donationForm');
      const thanks = document.getElementById('thanks');
      const thanksClose = document.getElementById('thanksClose');
      const submitBtn = document.getElementById('submitBtn');

      function showErr(el, msgId, msgText){
        if (!el) return;
        el.classList.add('field-error');
        const m = document.getElementById(msgId);
        if (m){ m.textContent = msgText; m.style.display = 'block'; }
      }
      function clearErr(el, msgId){
        if (!el) return;
        el.classList.remove('field-error');
        const m = document.getElementById(msgId);
        if (m) m.style.display = 'none';
      }

      function openThanks(){
        thanks.classList.add('show'); thanks.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';
        const closeBtn = document.getElementById('thanksClose'); closeBtn && closeBtn.focus();
      }
      function closeThanks(){
        thanks.classList.remove('show'); thanks.setAttribute('aria-hidden','true'); document.body.style.overflow='';
      }
      if (thanksClose) thanksClose.addEventListener('click', closeThanks);

      if (!form) return;
      form.addEventListener('submit', async function(e){
        e.preventDefault();
        // clear previous errors
        ['quantityErr','timeErr','locationErr','photoErr','foodTypesErr'].forEach(id => {
          const el = document.getElementById(id); if (el) el.style.display='none';
        });
        document.querySelectorAll('.field-error').forEach(x => x.classList.remove('field-error'));
        document.getElementById('foodTypes') && document.getElementById('foodTypes').classList.remove('err');

        // gather elements
        const selectedFoods = Array.from(document.querySelectorAll('.food-card.selected'));
        const from = form.querySelector('input[name="fromTime"]');
        const to = form.querySelector('input[name="toTime"]');
        const pincode = form.querySelector('input[name="pincode"]');
        const street = form.querySelector('input[name="street"]');
        const district = form.querySelector('input[name="district"]');
        const state = form.querySelector('input[name="state"]');
        const landmark = form.querySelector('input[name="landmark"]');
        const photo = form.querySelector('input[name="photo"]');
        const latField = document.getElementById('latField');
        const lngField = document.getElementById('lngField');

        // arrays for items
        const quantities = Array.from(form.querySelectorAll('input[name="quantity[]"]'));
        const itemNames = Array.from(form.querySelectorAll('input[name="itemName[]"]'));
        const serveCounts = Array.from(form.querySelectorAll('input[name="serveCount[]"]'));

        let invalid = false;

        // food types required
        if (!selectedFoods.length){
          invalid = true;
          const ft = document.getElementById('foodTypes');
          ft && ft.classList.add('err');
          const ferr = document.getElementById('foodTypesErr'); ferr && (ferr.style.display='block');
        }

        // validate quantities if provided
        quantities.forEach(q => {
          if (q.value && Number(q.value) <= 0) {
            q.classList.add('field-error');
            const qerr = document.getElementById('quantityErr'); if (qerr) { qerr.textContent = 'Quantity must be at least 1.'; qerr.style.display = 'block'; }
            invalid = true;
          } else {
            q.classList.remove('field-error');
          }
        });

        // times
        if (!from || !from.value || !to || !to.value){
          invalid = true;
          showErr(from || to, 'timeErr', 'Please select both timings.');
        } else {
          clearErr(from || to, 'timeErr');
        }

        // pickup location mandatory fields
        if (!pincode.value || !street.value || !district.value || !state.value){
          invalid = true;
          ['pincode','street','district','state'].forEach(name => {
            const el = form.querySelector(`[name="${name}"]`); el && el.classList.add('field-error');
          });
          showMessage('locationErr','Please fill all pickup location fields.');
        } else {
          ['pincode','street','district','state'].forEach(name => {
            const el = form.querySelector(`[name="${name}"]`); el && el.classList.remove('field-error');
          });
          hideMessage('locationErr');
        }

        // photo required + size validation
        if (!photo || !photo.files || !photo.files[0]){
          invalid = true;
          showMessage('photoErr','Please upload a food photo.');
          photo && photo.classList.add('field-error');
        } else {
          // size check
          const file = photo.files[0];
          if (file.size > MAX_UPLOAD_BYTES) {
            invalid = true;
            const mb = Math.round(MAX_UPLOAD_BYTES / 1024 / 1024 * 100) / 100;
            showMessage('photoErr', 'File is too large. Max allowed is ' + mb + ' MB.');
            photo.classList.add('field-error');
          } else {
            hideMessage('photoErr');
            photo.classList.remove('field-error');
          }
        }

        // ensure lat/lng are present (Use location required)
        if (!latField || !latField.value || !lngField || !lngField.value) {
          invalid = true;
          if (latField) latField.classList.add('field-error');
          if (lngField) lngField.classList.add('field-error');
          showMessage('locationErr', 'Please click "Use location" to detect latitude and longitude (mandatory).');
        } else {
          if (latField) latField.classList.remove('field-error');
          if (lngField) lngField.classList.remove('field-error');
        }

        if (invalid){
          const firstErr = document.querySelector('.field-error, .food-types.err, .err-msg[style*="block"]');
          firstErr && firstErr.scrollIntoView({behavior:'smooth',block:'center'});
          return;
        }

        // Build items array (only rows where any field is present)
        const items = [];
        for (let i = 0; i < itemNames.length; i++){
          const name = (itemNames[i].value || '').trim();
          const qty = (quantities[i] && quantities[i].value) ? quantities[i].value : null;
          const serves = (serveCounts[i] && serveCounts[i].value) ? Number(serveCounts[i].value) : null;
          if (name || qty || serves) {
            items.push({ itemName: name || null, quantity: qty || null, servesFor: serves || null });
          }
        }

        // Build DTO.
        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

        const dto = {
          type: 'FOOD',
          subTypes: Array.from(selectedFoods).map(s => s.dataset.value),
          description: '',
          pinCode: pincode.value,
          state: state.value,
          district: district.value,
          street: street.value,
          landmark: (landmark && landmark.value) ? landmark.value : null,
          availableFrom: today + 'T' + from.value + ':00',
          availableTo: today + 'T' + to.value + ':00',
          items: items,
          lat: latField && latField.value ? Number(latField.value) : null,
          lng: lngField && lngField.value ? Number(lngField.value) : null,
          useGeolocation: !!(latField && latField.value)
        };

        // build FormData (multipart) with JSON part named "data" and file part named "image"
        const fd = new FormData();
        const blob = new Blob([JSON.stringify(dto)], { type: 'application/json' });
        fd.append('data', blob);
        if (photo.files && photo.files[0]) fd.append('image', photo.files[0]);

        // disable submit button to prevent duplicate submits
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        try {
          const resp = await fetch('/api/donations', {
            method: 'POST',
            body: fd,
            credentials: 'include' // cookie auth
          });

          if (resp.status === 201 || resp.ok) {
            // success: show thanks, reset form
            openThanks();

            // reset form AFTER success
            form.reset();
            // clear selected food cards
            document.querySelectorAll('.food-card.selected').forEach(c => c.classList.remove('selected'));
            // clear photo preview
            const prev = document.getElementById('photoPreview');
            if (prev) { prev.style.display = 'none'; prev.src = ''; const ut = document.getElementById('uploadText'); if (ut) ut.style.display = 'block'; }
            // restore items area to initial state
            if (window.__kindora_restoreItems) window.__kindora_restoreItems();
          } else {
            // show error returned from backend
            let errText = 'Unable to submit donation. Please try again.';
            try { const json = await resp.json(); if (json && json.message) errText = json.message; } catch(e){}
            alert(errText);
          }
        } catch (error) {
          console.error('Submit error', error);
          alert('Network or server error while submitting donation. Please try again.');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Donation';
        }
      });
    })();
</script>
</body>
</html>
